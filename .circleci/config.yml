version: 2.1
jobs:
    build:
        machine:
            image: ubuntu-2004:202111-01
        steps:
            - checkout
            - restore_cache:
                keys:
                  - data-cache-v0-{{ checksum "./autoreject/__init__.py" }}-{{ checksum "setup.py" }}
            - run:
                name: Setup python3 environment
                command: |
                    python3 -m venv /home/circleci/autoreject_env
                    echo "source /home/circleci/autoreject_env/bin/activate" >> $BASH_ENV
            - run:
                name: Install packages
                command: |
                    python3 -m pip install --progress-bar off --upgrade pip setuptools wheel psutil
                    python3 -m pip install --progress-bar off -e .[full]
                    python3 -m pip install --progress-bar off -e .[doc]
            - run:
                name: Print system information
                command: |
                    date
                    python3 --version
                    which python3
                    pip3 --version
                    which pip3
                    mne sys_info
                    which mne
            - run:
                name: Download MNE sample data
                command: |
                  python3 -c "import mne; mne.datasets.sample.data_path()"
            - run:
                name: Build the documentation
                command: |
                    cd ~/project/doc
                    make html
                no_output_timeout: 2h
            - store_artifacts:
                path: ./doc/_build/html/
                destination: html
            - save_cache:
                key: data-cache-v0-{{ checksum "./autoreject/__init__.py" }}-{{ checksum "setup.py" }}
                paths:
                  - ~/.mne
                  - ~/mne_data/MNE-sample-data
                  - ~/project/examples/ds000117

workflows:
  commit:
    jobs:
      - build

  weekly:
    jobs:
      - build
    triggers:
      - schedule:
          cron: "0 4 * * 0"
          filters:
            branches:
              only:
                - master
